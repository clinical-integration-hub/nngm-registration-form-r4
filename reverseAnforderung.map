/// version = 0.1
/// title = "nNGM: Anforderung - FHIR to CTS"

map "http://uk-koeln.de/fhir/StructureMap/AnforderungCTS" = AnforderungCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformCTS(source src: Bundle, target tgt: CTS_Transport)
{
    src -> tgt.version = '1.1';
    src -> tgt.sourcesystem = 'https:\/\/nngm-qat.staging.healex.systems\/';
    
    src -> tgt.operations as operations collate, operations.crfid = '1-AF1';
    src -> tgt.operations as operations collate, operations.type = 'save';

    src.entry as entry then
    {
        entry.resource as specimen where "resource is Specimen" then
        {
            // Diagnostik Typ
            specimen -> tgt.operations as operations collate then
            {
                specimen -> operations.data as data then
                {
                    specimen.type as type then
                    {
                        type.coding as coding, coding.code as code then
                        {
                            specimen -> data.blockindex = 0;
                            specimen -> data.groupindex = 0;
                            specimen -> data.itemid = 'id_1368';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Zu untersuchendes Material (Biopsie-ID)
            /*specimen -> tgt.operations as operations collate then
            {
                specimen -> operations.data as data then
                {
                    specimen.value as value then 
                    {
                        specimen -> data.blockindex = 0;
                        specimen -> data.groupindex = 0;
                        specimen -> data.itemid = 'id_2457';
                        value -> data.values as values, values.value = value;
                    };
                };
            };*/

            // Entnahmedatum
            /*specimen -> tgt.operations as operations collate then
            {
                specimen -> operations.data as data then
                {
                    specimen.collection as collection then
                    {
                        collection.valueDateTime as valueDateTime then
                        {
                            specimen -> data.blockindex = 1;
                            specimen -> data.groupindex = 0;
                            specimen -> data.itemid = 'id_1551';
                            valueDateTime -> data.values as values, values.value = valueDateTime;
                        };
                    };
                };
            };*/

            // Materialentnahme erfolgte
            specimen -> tgt.operations as operations collate then
            {
                specimen -> operations.data as data then
                {
                    specimen.collection as collection then
                    {
                        collection.extension as aufenthaltsart then
                        {
                            aufenthaltsart.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as code then
                            {
                                specimen -> data.blockindex = 1;
                                specimen -> data.groupindex = 0;
                                specimen -> data.itemid  = 'id_1589';
                                code -> data.values as values, values.value = code;
                            };
                        };
                    };
                };
            };
        };
    };
}