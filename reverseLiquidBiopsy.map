/// version = 0.1
/// title = "nNGM: reverse LiquidBiopsy - FHIR to CTS"

map "http://uk-koeln.de/fhir/StructureMap/LiquidBiopsyMappingCTS" = LiquidBiopsyMappingCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformCTS(source src: Bundle, target tgt: CTS_Transport)
{
    src -> tgt.version = '1.1';
    src -> tgt.sourcesystem = 'https:\/\/nngm-qat.staging.healex.systems\/';
    
    src.entry as entry then
    {
        /* ------------------------------ Specimen ---------------------------- */
        entry.resource as specimen where "resource is Specimen" then
        {
            /* ------------------------------ Referenzen ---------------------------- */
            // Specimen
            specimen -> tgt.operations as operations collate then
            {
                specimen -> operations.data as data then
                {
                    specimen.identifier as identifier, identifier.value as value then
                    {
                        specimen -> data.blockindex = 1;
                        specimen -> data.groupindex = 0;
                        specimen -> data.itemid = 'assessment_id';
                        value -> data.values as values, values.value = value;
                    };
                };
            };
        };

        /* ------------------------------ Organization ---------------------------- */
        entry.resource as organization where "resource is Organization and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Organization/clinical-site'" then
        {
            /* ------------------------------ Netzwerkzentrum ---------------------------- */
            // Standort
            organization -> tgt.operations as operations collate then
            {
                organization -> operations.data as data then
                {
                    organization.name as name then
                    {
                        organization -> data.blockindex = 2;
                        organization -> data.groupindex = 0;
                        organization -> data.itemid = 'id_2435';
                        name -> data.values as values, values.value = name;
                    };
                };
            };

            /* ------------------------------ Netzwerkzentrum ---------------------------- */
            // SOP-Versionsnummer des Standorts
            organization -> tgt.operations as operations collate then
            {
                organization -> operations.data as data then
                {
                    organization.type as type, type.text as text then
                    {
                        organization -> data.blockindex = 2;
                        organization -> data.groupindex = 0;
                        organization -> data.itemid = 'id_2614';
                        text -> data.values as values, values.value = text;
                    };
                };
            };
        };

        /* ------------------------------ Observation ---------------------------- */
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ngs-fusion-expression'" then
        {
            /* ------------------------------ Methodik ---------------------------- */
            // Assay
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as code where "code = 'Assay'" then
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2601';
                        code -> data.values as values, values.value = code;
                    };
                };
            };

            /* ------------------------------ Methodik ---------------------------- */
            // Hersteller
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as code where "code = 'Hersteller'" then
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2602';
                        code -> data.values as values, values.value = code;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // Date of Assessment
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.valueDateTime as vdt then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2528';
                        vdt -> data.values as values, values.value = vdt;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // Phaenotyp
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueCodeableConcept as vcc, vcc.coding as coding where "coding.system = 'http://uk-koeln.de/fhir/ValueSet/phenotypes'" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1929';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // Gen
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then 
                {
                    observation.component as component, component.valueCodeableConcept as vcc, vcc.coding as coding where "coding.system = 'http://hl7.org/fhir/uv/genomics-reporting/ValueSet/hgnc'" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1928';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // Exon des 5' Gens
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.code as code, code.coding as coding where "coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1931';
                        component.valueInteger as integer -> data.values as values, values.value = integer;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // Referenztranskript 5' Gen
            // component:exon.valueInteger	1_LB1__4_0__lb_referencetranscript_5_end_gene
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueInteger as integer then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'lb_referencetranscript_5_end_gene';
                        integer -> data.values as values, values.value = integer;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // Exon des 3' Gens
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.code as code, code.coding as coding where "coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'lb_3_end_gene';
                        component.valueInteger as integer -> data.values as values, values.value = integer;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // Referenztranskript 3' Gen
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueInteger as integer then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'lb_referencetranscript_3_end_gen';
                        integer -> data.values as values, values.value = integer;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // HGVS c. (Mutation cDNA)
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueString as valueStr then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1930';
                        valueStr -> data.values as values, values.value = valueStr;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // HGVS p. (Mutation Protein)
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueString as valueStr then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1932';
                        valueStr -> data.values as values, values.value = valueStr;
                    };
                };
            };
        };

        entry.resource as serviceRequest where "resource is ServiceRequest and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/ServiceRequest/nNGM/testung'" then
        {
            /* ------------------------------ Status der Untersuchungen ---------------------------- */
            //Durchfuehrung
            serviceRequest -> tgt.operations as operations collate then
            {
                serviceRequest -> operations.data as data then
                {
                    serviceRequest.status as status then
                    {
                        serviceRequest -> data.blockindex = 5;
                        serviceRequest -> data.groupindex = 0;
                        serviceRequest -> data.itemid = 'id_2520';
                        status -> data.values as values, values.value = status;
                    };
                };
            };

            /* ------------------------------ Status der Untersuchungen ---------------------------- */
            //Abschluss
            serviceRequest -> tgt.operations as operations collate then
            {
                serviceRequest -> operations.data as data then
                {
                    serviceRequest.category as category, category.coding as coding, coding.code as code then
                    {
                        serviceRequest -> data.blockindex = 5;
                        serviceRequest -> data.groupindex = 0;
                        serviceRequest -> data.itemid = 'id_2462';
                        code -> data.values as values, values.value = code;
                    };
                };
            };

            /* ------------------------------ Status der Untersuchungen ---------------------------- */
            //Datum des Abschlusses
            serviceRequest -> tgt.operations as operations collate then
            {
                serviceRequest -> operations.data as data then
                {
                    serviceRequest.occurrenceDateTime as vdt then
                    {
                        serviceRequest -> data.blockindex = 5;
                        serviceRequest -> data.groupindex = 0;
                        serviceRequest -> data.itemid = 'id_2521';
                        vdt -> data.values as values, values.value = vdt;
                    };
                };
            };
        };
    };
}